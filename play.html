<head>
   <link rel="stylesheet" href="play.css">
</head>
<body>

   <div class="chat-score">ChatGPT Score: <span id="chatScore"></span></div>
   <div class="balance">Balance: <span id="balance"></span></div>
   <div class="button-container">
      <button onclick="goToShop()">Go to Shop</button>
  </div>

   <div class="frame">
      <div class="corner_topleft"></div>
      <div class="corner_topright"></div>
      <div class="corner_bottomleft"></div>
      <div class="corner_bottomright"></div>
      <div class="camera">
         <div class="map pixel-art">
            <div class="character" facing="down" walking="true">
               <div class="shadow pixel-art"></div>
               <div class="character_spritesheet pixel-art"></div>
            </div>
            <div class="tree"></div>
            <div class="tree2"></div>
            <div class="npc1"></div>
            <div class="computer"></div>
            <div class="npc2"></div>
            <div class="dnhs"></div>
            <button class="leaderboard-button" onclick="toggleLeaderboard()">Leaderboard (Click then go <-)</button>
            <div class="leaderboard-box" id="leaderboard-box">
               <div class="leaderboard-entry">| Rank | Name | Score |</div>
               <div class="leaderboard-entry">================</div>
               <div class="leaderboard-entry">| #1 | ShaneLopezz | 920 |</div>
               <div class="leaderboard-entry">| #2 | cookieBot34 | 600 |</div>
               <div class="leaderboard-entry">| #3 | blackifyy08 | 450 |</div>
               <div class="leaderboard-entry">| #4 | Tanav K | 300 |</div>
           </div>           
            <div class="dialog-box" id="dialog-box">Sup, can you help me real quick? (Click)</div>
            <div class="dialog-box" id="npc2-dialog-box">Hey there! Can you help me with something? (Click)</div>
         </div>
         <script>
            var character = document.querySelector(".character");
            var map = document.querySelector(".map");
            var dialogBox = document.getElementById("dialog-box");
            var x = 90;
            var y = 80;
            var held_directions = [];
            var speed = 1;
            // Dialogue steps
            var dialogue = [ "aa", "I got a CSA Final with Mort, and I didn't study..", "I remember some questions but not the answers...", "I left my computer somewhere..", " and the question is on there..", " can you find it and answer?"];
            var dialogueIndex = 0;
            // Event listener for dialog box clicks
            dialogBox.addEventListener("click", function() {
               dialogueIndex++;
               if (dialogueIndex < dialogue.length) {
                  dialogBox.textContent = dialogue[dialogueIndex];
               } else if (dialogueIndex === dialogue.length) {
                  var playerName = prompt("Sure or nah?");
                  console.log("Player name:", playerName);
                  dialogBox.style.display = 'none';
               }
            });
            const blockedZones = [
            { x: 17, y: 50 }, //npc 1 pos 
            { x: 16, y: 96 }, //tree
            { x: 152, y: 96 },  // tree 2
            { x: 170, y: 55 },  // computer
            { x: 125, y: 30 }, //npc 2 
]           ;
            const isBlocked = (newX, newY) => {
               return blockedZones.some(zone => {
                  return Math.abs(zone.x - newX) < 8 && Math.abs(zone.y - newY) < 8;
               });
            };
            const placeCharacter = () => {
               var pixelSize = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--pixel-size'));
               const held_direction = held_directions[0];
               let newX = x;
               let newY = y;
               if (held_direction) {
                  if (held_direction === directions.right) { newX += speed; }
                  if (held_direction === directions.left) { newX -= speed; }
                  if (held_direction === directions.down) { newY += speed; }
                  if (held_direction === directions.up) { newY -= speed; }
                  // Check if the new position is blocked
                  if (!isBlocked(newX, newY)) {
                     x = newX;
                     y = newY;
                     character.setAttribute("facing", held_direction);
                  }
               }
               character.setAttribute("walking", held_direction ? "true" : "false");
               // Boundary limits to keep character in view
               var leftLimit = -8;
               var rightLimit = (16 * 11) + 8;
               var topLimit = -8 + 32;
               var bottomLimit = (16 * 7);
               if (x < leftLimit) { x = leftLimit; }
               if (x > rightLimit) { x = rightLimit; }
               if (y < topLimit) { y = topLimit; }
               if (y > bottomLimit) { y = bottomLimit; }
               // Camera position
               var camera_left = pixelSize * 66;
               var camera_top = pixelSize * 42;
               map.style.transform = `translate3d( ${-x * pixelSize + camera_left}px, ${-y * pixelSize + camera_top}px, 0 )`;
               character.style.transform = `translate3d( ${x * pixelSize}px, ${y * pixelSize}px, 0 )`;
               // Check if the character is in the dialog area
               checkDialogArea(x, y);
            };
            var npc2DialogBox = document.getElementById("npc2-dialog-box");
            var npc2Dialogue = [
               "Hi! I seem to have lost my notes for the CSA final...",
               "Can you help me find them? It would mean a lot!",
               "Thanks! Just let me know when youâ€™re done."
            ];
            var npc2DialogueIndex = 0;
            
            // Add an event listener for `npc2` dialog box clicks
            npc2DialogBox.addEventListener("click", function() {
               npc2DialogueIndex++;
               if (npc2DialogueIndex < npc2Dialogue.length) {
                  npc2DialogBox.textContent = npc2Dialogue[npc2DialogueIndex];
               } else {
                  npc2DialogBox.style.display = 'none';
               }
            });
            
            // Update the `checkDialogArea` function to also check for `npc2`
            const checkDialogArea = (x, y) => {
               const dialogAreaNPC1 = { left: 32, right: 100, top: 192, bottom: 240 };
               const dialogAreaNPC2 = { left: 125, right: 145, top: 30, bottom: 50 };
            
               // Check if the character is within the dialog area for `npc1`
               if (x >= dialogAreaNPC1.left && x <= dialogAreaNPC1.right && y >= dialogAreaNPC1.top && y <= dialogAreaNPC1.bottom) {
                  dialogBox.style.display = 'block';
                  dialogBox.style.left = `${x * parseInt(getComputedStyle(document.documentElement).getPropertyValue('--pixel-size')) + 10}px`;
                  dialogBox.style.top = `${y * parseInt(getComputedStyle(document.documentElement).getPropertyValue('--pixel-size')) - 10}px`;
               } else {
                  dialogBox.style.display = 'none';
                  dialogueIndex = 0;
               }
            
               // Check if the character is within the dialog area for `npc2`
               if (x >= dialogAreaNPC2.left && x <= dialogAreaNPC2.right && y >= dialogAreaNPC2.top && y <= dialogAreaNPC2.bottom) {
                  npc2DialogBox.style.display = 'block';
                  npc2DialogBox.style.left = `${x * parseInt(getComputedStyle(document.documentElement).getPropertyValue('--pixel-size')) + 10}px`;
                  npc2DialogBox.style.top = `${y * parseInt(getComputedStyle(document.documentElement).getPropertyValue('--pixel-size')) - 10}px`;
               } else {
                  npc2DialogBox.style.display = 'none';
                  npc2DialogueIndex = 0;
               }
            };
            
            const step = () => {
               placeCharacter();
               window.requestAnimationFrame(() => {
                  step();
               });
            };
            step();
            const directions = {
               up: "up",
               down: "down",
               left: "left",
               right: "right",
            };
            function toggleLeaderboard() {
               var leaderboardBox = document.getElementById("leaderboard-box");
               leaderboardBox.style.display = leaderboardBox.style.display === "block" ? "none" : "block";
            }            
            const keys = {
               38: directions.up,
               37: directions.left,
               39: directions.right,
               40: directions.down,
            };
            document.addEventListener("keydown", (e) => {
               var dir = keys[e.which];
               if (dir && held_directions.indexOf(dir) === -1) {
                  held_directions.unshift(dir);
               }
            });
            document.addEventListener("keyup", (e) => {
               var dir = keys[e.which];
               var index = held_directions.indexOf(dir);
               if (index > -1) {
                  held_directions.splice(index, 1);
               }
            });

            function goToShop() {
               window.location.href = 'http://127.0.0.1:5500/shop.html';
           }
         </script>

<script type="module">
   import { javaURI, fetchOptions } from 'http://127.0.0.1:5500/assets/js/api/config.js';
   function getChatScoreBalance() {
   
      const playerid = 1
      const getChatScoreUrl = `${javaURI}/rpg_answer/getChatScore/` + playerid;
      const getBadgeCountUrl = `${javaURI}/rpg_answer/getBalance/` + playerid;
      
   
      fetch(getChatScoreUrl, fetchOptions)
      .then(response => {
          // Handle server response
          if (response.status !== 200) {
              const errorMsg = 'Database response error: ' + response.status;
              console.log(errorMsg);
              document.getElementById("chatScore").innerHTML = 10;
          }
   
          // Response contains valid result
          response.json().then(data => {
              if (data !== null) {
                  console.log(data)
                  document.getElementById("chatScore").innerHTML = data;
              }
          });
      })
      .catch(error => {
          // Handle fetch errors
          console.error('Fetch error:', error);
      });
   
   
   fetch(getBadgeCountUrl, fetchOptions)
      .then(response => {
          // Handle server response
          if (response.status !== 200) {
              const errorMsg = 'Database response error: ' + response.status;
              console.log(errorMsg);
              document.getElementById("balance").innerHTML = 0;
          }
   
          // Response contains valid result
          response.json().then(data => {
              if (data !== null) {
                  console.log(data)
                  document.getElementById("balance").innerHTML = data;
              }
          });
      })
      .catch(error => {
          // Handle fetch errors
          console.error('Fetch error:', error);
      });
   }
   
   
   getChatScoreBalance()
   
   </script>
</body>