<head>
   <link rel="stylesheet" href="play.css">
   <style>
      /* Style for dialog boxes to ensure they appear above the NPCs */
      .dialog-box {
         position: absolute;
         background-color: white;
         border: 1px solid black;
         padding: 5px;
         z-index: 10;
         display: none; /* Initially hidden */
      }

      /* NPC-specific dialog box positioning adjustments */
      #npc1-dialog-box {
         top: 200px; /* Adjust based on NPC1's position */
         left: 15px;
      }

      #npc2-dialog-box {
         top: 100px; /* Adjust based on NPC2's position */
         left: 400px;
      }
   </style>
</head>
<body>

   <div class="chat-score">ChatGPT Score: <span id="chatScore"></span></div>
   <div class="balance">Balance: <span id="balance"></span></div>
   <div class="button-container">
      <button onclick="goToShop()">Go to Shop</button>
   </div>

   <div class="frame">
      <div class="corner_topleft"></div>
      <div class="corner_topright"></div>
      <div class="corner_bottomleft"></div>
      <div class="corner_bottomright"></div>
      <div class="camera">
         <div class="map pixel-art">
            <div class="character" facing="down" walking="true">
               <div class="shadow pixel-art"></div>
               <div class="character_spritesheet pixel-art"></div>
            </div>
            <div class="tree"></div>
            <div class="tree2"></div>
            <div class="npc1"></div>
            <div class="computer"></div>
            <div class="npc2"></div>
            <div class="dnhs"></div>
            <button class="leaderboard-button" onclick="toggleLeaderboard()">Leaderboard (Click then go <-)</button>
            <div class="leaderboard-box" id="leaderboard-box">
               <div class="leaderboard-entry">| Rank | Name | Score |</div>
               <div class="leaderboard-entry">================</div>
               <div class="leaderboard-entry">| #1 | ShaneLopezz | 920 |</div>
               <div class="leaderboard-entry">| #2 | cookieBot34 | 600 |</div>
               <div class="leaderboard-entry">| #3 | blackifyy08 | 450 |</div>
               <div class="leaderboard-entry">| #4 | Tanav K | 300 |</div>
           </div>           
            <div class="dialog-box" id="dialog-box">Sup, can you help me real quick? (Click)</div>
            <div class="dialog-box" id="npc2-dialog-box">Hey there! Can you help me with something? (Click)</div>
            <div class="dialog-box" id="npc1-dialog-box">Hello there! I need your help with something. (Click)</div>
         </div>
         <script>
            var character = document.querySelector(".character");
            var map = document.querySelector(".map");
            var dialogBox = document.getElementById("dialog-box");
            var x = 90;
            var y = 80;
            var held_directions = [];
            var speed = 1;

            // Dialogue steps for NPC1 and NPC2
            var dialogue = [ "aa", "I got a CSA Final with Mort, and I didn't study..", "I remember some questions but not the answers...", "I left my computer somewhere..", " and the question is on there..", " can you find it and answer?"];
            var dialogueIndex = 0;

            dialogBox.addEventListener("click", function() {
               dialogueIndex++;
               if (dialogueIndex < dialogue.length) {
                  dialogBox.textContent = dialogue[dialogueIndex];
               } else if (dialogueIndex === dialogue.length) {
                  var playerName = prompt("Sure or nah?");
                  console.log("Player name:", playerName);
                  dialogBox.style.display = 'none';
               }
            });

            // NPC2 Dialog Box
            var npc2DialogBox = document.getElementById("npc2-dialog-box");
            var npc2Dialogue = [
               "Hi! I seem to have lost my notes for the CSA final...",
               "Can you help me find them? It would mean a lot!",
               "Thanks! Just let me know when youâ€™re done."
            ];
            var npc2DialogueIndex = 0;

            npc2DialogBox.addEventListener("click", function() {
               npc2DialogueIndex++;
               if (npc2DialogueIndex < npc2Dialogue.length) {
                  npc2DialogBox.textContent = npc2Dialogue[npc2DialogueIndex];
               } else {
                  npc2DialogBox.style.display = 'none';
               }
            });

            // NPC1 Dialog Box
            var npc1DialogBox = document.getElementById("npc1-dialog-box");
            var npc1Dialogue = [
               "Yo!",
               "You look like a nerd.. but nerds can be useful!",
               "Can you look around and bring it to me?",
               "Thank you so much!"
            ];
            var npc1DialogueIndex = 0;

            npc1DialogBox.addEventListener("click", function() {
               npc1DialogueIndex++;
               if (npc1DialogueIndex < npc1Dialogue.length) {
                  npc1DialogBox.textContent = npc1Dialogue[npc1DialogueIndex];
               } else {
                  npc1DialogBox.style.display = 'none';
               }
            });

            // Blocked zones and dialog areas
            const blockedZones = [
               { x: 17, y: 49.9 }, // NPC1 pos 
               { x: 16, y: 96 },   // tree
               { x: 152, y: 96 },  // tree 2
               { x: 170, y: 55 },  // computer
               { x: 125, y: 30 },  // NPC2
            ];

            const isBlocked = (newX, newY) => {
               return blockedZones.some(zone => {
                  return Math.abs(zone.x - newX) < 8 && Math.abs(zone.y - newY) < 8;
               });
            };

            const placeCharacter = () => {
               var pixelSize = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--pixel-size'));
               const held_direction = held_directions[0];
               let newX = x;
               let newY = y;
               if (held_direction) {
                  if (held_direction === directions.right) { newX += speed; }
                  if (held_direction === directions.left) { newX -= speed; }
                  if (held_direction === directions.down) { newY += speed; }
                  if (held_direction === directions.up) { newY -= speed; }
                  if (!isBlocked(newX, newY)) {
                     x = newX;
                     y = newY;
                     character.setAttribute("facing", held_direction);
                  }
               }
               character.setAttribute("walking", held_direction ? "true" : "false");

               // Boundary limits
               var leftLimit = -8;
               var rightLimit = (16 * 11) + 8;
               var topLimit = -8 + 32;
               var bottomLimit = (16 * 7);
               if (x < leftLimit) { x = leftLimit; }
               if (x > rightLimit) { x = rightLimit; }
               if (y < topLimit) { y = topLimit; }
               if (y > bottomLimit) { y = bottomLimit; }

               // Camera position
               var camera_left = pixelSize * 66;
               var camera_top = pixelSize * 42;
               map.style.transform = `translate3d( ${-x * pixelSize + camera_left}px, ${-y * pixelSize + camera_top}px, 0 )`;
               character.style.transform = `translate3d( ${x * pixelSize}px, ${y * pixelSize}px, 0 )`;

               // Check dialog areas
               checkDialogArea(x, y);
            };

            const checkDialogArea = (x, y) => {
               const dialogAreaNPC1 = { left: 16, right: 30, top: 40, bottom: 60 };
               const dialogAreaNPC2 = { left: 125, right: 145, top: 30, bottom: 50 };

               // NPC1 dialog
               if (x >= dialogAreaNPC1.left && x <= dialogAreaNPC1.right && y >= dialogAreaNPC1.top && y <= dialogAreaNPC1.bottom) {
                  npc1DialogBox.style.display = 'block';
               } else {
                  npc1DialogBox.style.display = 'none';
                  npc1DialogueIndex = 0;
               }

               // NPC2 dialog
               if (x >= dialogAreaNPC2.left && x <= dialogAreaNPC2.right && y >= dialogAreaNPC2.top && y <= dialogAreaNPC2.bottom) {
                  npc2DialogBox.style.display = 'block';
               } else {
                  npc2DialogBox.style.display = 'none';
                  npc2DialogueIndex = 0;
               }
            };

            const step = () => {
               placeCharacter();
               window.requestAnimationFrame(() => {
                  step();
               });
            };

            step();

            const directions = {
               up: "up",
               down: "down",
               left: "left",
               right: "right",
            };

            const keys = {
               38: directions.up,
               37: directions.left,
               39: directions.right,
               40: directions.down,
            };

            document.addEventListener("keydown", (e) => {
               var dir = keys[e.which];
               if (dir && held_directions.indexOf(dir) === -1) {
                  held_directions.unshift(dir);
               }
            });

            document.addEventListener("keyup", (e) => {
               var dir = keys[e.which];
               var index = held_directions.indexOf(dir);
               if (index > -1) {
                  held_directions.splice(index, 1);
               }
            });

            function toggleLeaderboard() {
               var leaderboardBox = document.getElementById("leaderboard-box");
               leaderboardBox.style.display = leaderboardBox.style.display === "block" ? "none" : "block";
            }

            function goToShop() {
               window.location.href = 'http://127.0.0.1:5500/shop.html';
           }
         </script>
      </div>
   </div>

</body>
